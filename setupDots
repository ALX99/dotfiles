#!/usr/bin/env bash
set -euo pipefail

# Color variables
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

run_command() {
  echo -e "${YELLOW}Running:${NC} $*"
  "$@"
}

complete_message() {
  echo -e "${GREEN}$1 completed.${NC}"
}

remove_broken_symlinks() {
  local target_dir="$1"
  echo -e "${YELLOW}Checking for broken symlinks in ${target_dir}${NC}"

  # Find and remove only broken symlinks that point to the dotfiles directory
  while IFS= read -r -d '' link; do
    if [[ ! -e $link ]]; then
      local link_target
      link_target=$(readlink "$link")
      if [[ $link_target == *"dotfiles"* ]]; then
        echo -e "${YELLOW}Removing broken symlink:${NC} $link -> $link_target"
        rm -f "$link"
      fi
    fi
  done < <(find "$target_dir" -type l -print0 2>/dev/null)
}

user_config() {
  run_command mkdir -p ~/.config
  run_command mkdir -p ~/.local

  remove_broken_symlinks ~/.local
  run_command stow --dir "$PWD" --target ~/.local --restow --no-folding .local

  remove_broken_symlinks ~/.claude
  run_command stow --dir "$PWD" --target ~ --restow --no-folding home

  remove_broken_symlinks ~/.config
  run_command stow --dir "$PWD" --target ~/.config --restow .config

  if [[ "$(uname)" == "Linux" ]]; then
    run_command systemctl --user enable ssh-agent
    run_command systemctl --user start ssh-agent
  fi
}

linux_system_config() {
  run_command sudo ln -sf "$PWD"/misc/keymaps/colemak /usr/share/X11/xkb/symbols/colemak
  run_command sudo ln -sf "$PWD"/misc/keymaps/keyd.conf /etc/keyd/default.conf

  run_command sudo mkdir -p -m 755 \
    /etc/systemd/sleep.conf.d/ \
    /etc/systemd/logind.conf.d/ \
    /etc/systemd/resolved.conf.d/

  # Systemd runs in a sandbox and does not have access to user directories by default.
  # That's why we copy things
  run_command sudo rm -f /etc/systemd/sleep.conf.d/99-sleep.conf
  run_command sudo cp -f "$PWD"/misc/systemd-config/99-sleep.conf /etc/systemd/sleep.conf.d/

  # sudoers
  run_command sudo ln -sf "$PWD"/misc/99-sudoers /etc/sudoers.d/
  run_command sudo chown root:root /etc/sudoers.d/99-sudoers

  # logind
  run_command sudo rm -f /etc/systemd/logind.conf.d/99-logind.conf
  run_command sudo cp -f "$PWD"/misc/systemd-config/99-logind.conf /etc/systemd/logind.conf.d/

  run_command sudo sed -i '/Color/s/^#//g' /etc/pacman.conf

  run_command sudo ln -sf "$PWD"/misc/pacman-hooks /etc/pacman.d/hooks
  run_command sudo ln -sfT dash /usr/bin/sh

  # Udev rules
  run_command sudo bash -c "sed -e 's|__USER__|'$USER'|g' -e 's|__HOME__|'$HOME'|g' '$PWD/misc/99-power.rules.in' > /etc/udev/rules.d/99-power.rules"
  run_command sudo udevadm control --reload-rules
  run_command sudo udevadm trigger
  echo -e "${GREEN}Udev rules set up.${NC}"
}

mac_system_config() {
  echo -e "${YELLOW}No macOS-specific automation is defined yet.${NC}"
  echo -e "${YELLOW}Add tasks here when macOS setup steps are available.${NC}"
}

main_menu() {
  echo -e "${YELLOW}Select an option:${NC}"
  options=("User Configuration" "Linux (Arch) System Configuration" "Mac System Configuration" "Quit")
  select _ in "${options[@]}"; do
    case $REPLY in
    1)
      user_config
      complete_message "${options[0]}"
      ;;
    2)
      linux_system_config
      complete_message "${options[1]}"
      ;;
    3)
      mac_system_config
      complete_message "${options[2]}"
      ;;
    4)
      break
      ;;
    *)
      echo -e "${RED}Invalid option${NC}"
      ;;
    esac
  done
}

run_option() {
  local option="${1:-}"
  case "$option" in
  1)
    user_config
    complete_message "User Configuration"
    ;;
  2)
    linux_system_config
    complete_message "Linux (Arch) System Configuration"
    ;;
  3)
    mac_system_config
    complete_message "Mac System Configuration"
    ;;
  4 | q | quit)
    return 0
    ;;
  *)
    echo -e "${RED}Invalid option: ${option}${NC}"
    echo "Usage: $0 [1|2|3|4]"
    return 2
    ;;
  esac
}

if [[ ${1:-} != "" ]]; then
  run_option "$1"
else
  main_menu
fi
