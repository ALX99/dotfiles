#!/usr/bin/env bash

set -euo pipefail

show_help() {
  if ! "$@" >/dev/null 2>&1; then
    echo "failed: $@"
    return
  fi

  if command -v bat >/dev/null 2>&1; then
    "$@" | bat --plain --language=help &&
      echo "$@" &&
      exit 0
  else
    "$@" &&
      echo "$@" &&
      exit 0
  fi
}

#shellcheck disable=SC2206
args=($READLINE_LINE)

if bash -ic "alias ${args[0]}" &>/dev/null; then
  expanded="$(bash -ic "alias ${args[0]}" | sed "s/^alias [^=]*='//; s/'$//")"
  echo "Expanded alias: ${args[0]} -> $expanded"
  args=($expanded)
fi

cmd=()
for arg in "${args[@]}"; do
  if [[ ! $arg =~ ^- ]]; then
    cmd+=("$arg")
  else
    break
  fi
done

while [ ${#cmd[@]} -gt 0 ]; do
  show_help "${cmd[@]}" --help
  show_help "${cmd[@]}" -h
  show_help "${cmd[@]}" -?
  show_help "${cmd[@]}" help
  show_help "${cmd[@]}" usage
  cmd=("${cmd[@]:0:${#cmd[@]}-1}")
done
