#!/bin/sh
# The DWM bar

delim="|"

# Handle SIGTRAP signals sent by refbar to update the status bar immediately.
trap 'update' 5

# The big status function
status() { \

	# Wifi quality percentage and  icon if ethernet is connected.
	grep "^\s*w" /proc/net/wireless | awk '{ print "", int($3 * 100 / 70) "%" }'
	sed "s/down//;s/up//" /sys/class/net/e*/operstate
    echo "$delim"

    # Grep first battery percentage
    percentage=$(cat /sys/class/power_supply/BAT0/capacity)
    if [ $? -eq 0 ]; then
        case $percentage in
		    100|9[0-9]|8[3-9])	    echo " $percentage%" ;;
		    8[0-2]|7[0-9]|6[6-9])	echo " $percentage%" ;;
	    	6[0-5]|5[0-9]|49)   	echo " $percentage%" ;;
	    	4[0-8]|3[2-9])	        echo " $percentage%" ;;
	    	3[0-1]|2[0-9]|1[5-9])	echo " $percentage%" ;;
            *)                      echo " $percentage%";;
        esac
    fi
    echo "$delim"

    # Brightness
    echo "$(xbacklight -get | sed 's/\..*//')%  $delim"

    # Get the volume of ALSA's master volume output.  Show an icon if or
	# not muted.
	amixer get Master | grep -o "[0-9]*%\|\[on\]\|\[off\]" | sed "s/\[on\]//;s/\[off\]//"
	echo "$delim"

	# Date and time.
	date '+%Y %b %d (%a) %I:%M%p'
	}

update() { \
	# So all that big status function was just a command that quicking gets
	# what we want to be the statusbar. This xsetroot command is what sets
	# it. Note that the tr command replaces newlines with spaces. This is
	# to prevent some weird issues that cause significant slowing of
	# everything in dwm. Note entirely sure of the cause, but again, the tr
	# command easily avoids it.
	xsetroot -name "$(status | tr '\n' ' ')" &
    wait

}
while :; do
    update
    # Sleep for a minute in the background and use wait since
    # traps can interrupt wait immediately
	sleep 1m &
    wait
done
