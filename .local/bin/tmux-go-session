#!/usr/bin/env bash
set -euo pipefail

PROJ_DIR="${PROJ_DIR:-$HOME/projects}"

list_projects() {
  local dir path
  local IFS=:
  while IFS= read -r dir; do
    printf "%s\t%s\n" "${dir##*/}" "$dir"
  done <<<"$(
    for path in $PROJ_DIR; do
      [ -d "$path" ] && find "$path" -mindepth 1 -maxdepth 1 -type d
    done
    echo "$HOME/dotfiles"
    echo "$HOME/.claude"
  )"
}

# shellcheck disable=SC2016
selected_entry="$(
  list_projects |
    fzf-tmux -p 80%,90% --prompt 'tmux session > ' --with-nth=1 --delimiter '\t' \
      --preview 'dir={2}; readme=$(find "$dir" -maxdepth 1 -type f \( -iname "readme" -o -iname "readme.*" \) | head -n1); if [[ -n "$readme" ]]; then if command -v bat >/dev/null 2>&1; then bat --style=plain --color=always --paging=never "$readme"; else cat "$readme"; fi; elif git -C "$dir" rev-parse --is-inside-work-tree >/dev/null 2>&1; then git -C "$dir" log --color --graph --pretty=format:"%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset" --abbrev-commit | head -200; else ls --color=always -al "$dir"; fi' \
      --preview-window=right,60% ||
    :
)"

[[ -z ${selected_entry:-} ]] && exit 0

selected_name="${selected_entry%%$'\t'*}"
selected_dir="${selected_entry#*$'\t'}"
session_name="${selected_name//./_}" # tmux dislikes dots

if [[ -z ${TMUX:-} ]]; then
  tmux new-session -As "$session_name" -c "$selected_dir"
  exit 0
elif ! tmux has-session -t="$session_name" 2>/dev/null; then
  tmux new-session -ds "$session_name" -c "$selected_dir"
fi

if [[ -z ${TMUX:-} ]]; then
  tmux attach-session -t "$session_name"
else
  tmux switch-client -t "$session_name"
fi
