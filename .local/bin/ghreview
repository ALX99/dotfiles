#!/usr/bin/env bash

set -euo pipefail

if [[ $# -eq 1 ]]; then
  pr="$1"
else
  pr=$(gh pr list --json number,title,author,createdAt \
    --template '{{range .}}{{.number}}	{{.author.login}}	{{.title}}{{"\n"}}{{end}}' |
    fzf --prompt="Select PR: " | cut -f1)
  [[ -n $pr ]] || exit 0
fi

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z $repo_root ]]; then
  echo "ghreview must be run inside a git repository." >&2
  exit 1
fi

worktree_dir="$repo_root/review-$pr"
branch="review-$pr"

if [[ -d $worktree_dir ]]; then
  echo "Worktree path already exists: $worktree_dir" >&2
  exit 1
fi

branch_preexisting=0
if git -C "$repo_root" show-ref --verify --quiet "refs/heads/$branch"; then
  branch_preexisting=1
fi

cleanup() {
  cd "$repo_root"
  git worktree remove --force "$worktree_dir" 2>/dev/null || true
  if [[ $branch_preexisting -eq 0 ]]; then
    git branch -D "$branch" 2>/dev/null || true
  fi
}
trap cleanup EXIT INT TERM

git -C "$repo_root" worktree add --detach "$worktree_dir"

cd "$worktree_dir"
gh pr checkout "$pr" --branch "$branch"

code --new-window --wait "$worktree_dir"
