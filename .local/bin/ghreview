#!/usr/bin/env bash

set -euo pipefail

if [[ $# -eq 1 ]]; then
  pr_url="$1"
  if [[ $pr_url =~ github\.com/([^/]+/[^/]+)/pull/([0-9]+) ]]; then
    repo_full="${BASH_REMATCH[1]}"
    pr="${BASH_REMATCH[2]}"
  else
    echo "Invalid PR URL or format: $pr_url" >&2
    exit 1
  fi
else
  pr_selection=$(gh search prs --review-requested=@me --json number,title,repository,author,updatedAt \
    --template '{{range .}}{{.repository.nameWithOwner}}{{"\t"}}{{.number}}{{"\t"}}{{.author.login}}{{"\t"}}{{.title}}{{"\n"}}{{end}}' |
    fzf --prompt="Select PR to review: " --delimiter='\t' --with-nth=1,2,4)
  [[ -n $pr_selection ]] || exit 0

  repo_full=$(echo "$pr_selection" | cut -f1)
  pr=$(echo "$pr_selection" | cut -f2)
fi

review_dir=$(mktemp -d -t "ghreview-$pr-XXXXXX")

cleanup() {
  rm -rf "$review_dir"
}
trap cleanup EXIT INT TERM

echo "Fetching PR #$pr from $repo_full (shallow clone)..."

# Get repo URL and base branch
repo_url=$(gh repo view "$repo_full" --json url --jq .url)
base_branch=$(gh pr view "$pr" --repo "$repo_full" --json baseRefName --jq .baseRefName)

# Initialize repo and fetch only the PR + base branch
cd "$review_dir"
git init --quiet
git remote add origin "$repo_url"
git fetch --depth=1 origin "pull/$pr/head:pr-$pr" "$base_branch" 2>&1 | grep -v "^From"
git checkout --quiet "pr-$pr"

echo "âœ“ Checked out PR #$pr (base: $base_branch)"

code --new-window --wait "$review_dir"
