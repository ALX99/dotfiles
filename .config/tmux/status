#!/usr/bin/env bash
set -euo pipefail

grey="#[fg=colour244]"
accent="#[fg=colour250]"
warn="#[fg=colour178]"
crit="#[fg=colour196]"
reset="#[fg=default]"

get_time() {
  printf "%s%s%s" "$accent" "$(date +'%H:%M')" "$reset"
}

get_bat() {
  local percentage status colour=""
  case "$(uname)" in
  Linux)
    if [[ -r /sys/class/power_supply/BAT0/capacity ]]; then
      percentage="$(cat /sys/class/power_supply/BAT0/capacity)"
      status="$(cat /sys/class/power_supply/BAT0/status 2>/dev/null || true)"
    else
      return
    fi
    ;;
  Darwin)
    percentage="$(pmset -g batt | grep -Eo "\d+%" | cut -d% -f1)"
    status="$(pmset -g batt | grep -qi 'charging' && echo 'Charging' || true)"
    ;;
  *)
    return
    ;;
  esac

  if [[ $percentage -le 15 ]]; then
    colour="$crit"
  elif [[ $percentage -le 40 ]]; then
    colour="$warn"
  else
    colour="$accent"
  fi

  if [[ $status == "Charging" ]]; then
    printf "%sbat %s%s%%%s" "$grey" "$accent" "$percentage" "$reset"
  else
    printf "%sbat %s%s%%%s" "$grey" "$colour" "$percentage" "$reset"
  fi
}

sections=()
bat="$(get_bat || true)"
if [[ -n ${bat:-} ]]; then
  sections+=("$bat")
fi
sections+=("$(get_time)")

printf "%s" "$(
  IFS=' Â· '
  echo "${sections[*]}"
)"
